/* Copyright (c) 2018 The Brave Authors. All rights reserved.
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at https://mozilla.org/MPL/2.0/. */

const path = require('path')
const fs = require('fs')
const config = require('../lib/config')
const util = require('../lib/util')
const l10nUtil = require('./l10nUtil')

const srcDir = config.srcDir

const resetChromeStringFiles = () => {
  // Revert to originals before string replacement because original grd(p)s are
  // overwritten with modified versions from ./src/brave during build.
  const targetFilesForReset = ['*.grd', '*.grdp']
  targetFilesForReset.forEach((targetFile) => {
    util.run('git', ['checkout', '--', targetFile], { cwd: srcDir })
  })
}

// Copy post-processed Brave strings to Brave Origin strings.
const copyBraveStringsToOrigin = () => {
  // Copy components_brave_strings.grd to components_brave_origin_strings.grd
  // (no XTB path changes needed as they share the same XTB files).
  const componentsSrc = path.join(
    srcDir,
    'brave',
    'components',
    'components_brave_strings.grd',
  )
  const componentsDest = path.join(
    srcDir,
    'brave',
    'components',
    'components_brave_origin_strings.grd',
  )
  console.log(
    'Copying Brave Origin strings: '
      + path.relative(srcDir, componentsDest)
      + ' <- '
      + path.relative(srcDir, componentsSrc),
  )
  fs.copyFileSync(componentsSrc, componentsDest)

  // Copy brave_strings.grd to brave_origin_strings.grd and update XTB paths.
  const braveStringsSrc = path.join(srcDir, 'brave', 'app', 'brave_strings.grd')
  const braveStringsDest = path.join(
    srcDir,
    'brave',
    'app',
    'brave_origin_strings.grd',
  )
  console.log(
    'Copying Brave Origin strings: '
      + path.relative(srcDir, braveStringsDest)
      + ' <- '
      + path.relative(srcDir, braveStringsSrc),
  )
  let grdContent = fs.readFileSync(braveStringsSrc, 'utf8')
  // Update XTB file paths from brave_strings_*.xtb to
  // brave_origin_strings_*.xtb
  grdContent = grdContent.replace(
    /brave_strings_([^"]+\.xtb)/g,
    'brave_origin_strings_$1',
  )
  fs.writeFileSync(braveStringsDest, grdContent, 'utf8')

  // Copy XTB files for brave_strings (brave_origin_strings uses different XTB
  // files than brave_strings, unlike components which share the same XTB
  // files).
  const resourcesDir = path.join(srcDir, 'brave', 'app', 'resources')
  const xtbFiles = fs
    .readdirSync(resourcesDir)
    .filter(
      (file) => file.startsWith('brave_strings_') && file.endsWith('.xtb'),
    )
  for (const sourceFile of xtbFiles) {
    const sourceXtb = path.join(resourcesDir, sourceFile)
    const destFile = sourceFile.replace(
      'brave_strings_',
      'brave_origin_strings_',
    )
    const destXtb = path.join(resourcesDir, destFile)
    console.log(
      'Copying Brave Origin XTB: '
        + path.relative(srcDir, destXtb)
        + ' <- '
        + path.relative(srcDir, sourceXtb),
    )
    fs.copyFileSync(sourceXtb, destXtb)
  }
}

const chromiumRebaseL10n = async (options) => {
  resetChromeStringFiles()
  const removed = await l10nUtil.rebaseBraveStringFilesOnChromiumL10nFiles()
  l10nUtil.getBraveAutoGeneratedPaths().forEach((sourceStringPath) => {
    const cmdOptions = config.defaultOptions
    cmdOptions.cwd = config.braveCoreDir
    util.run(
      'vpython3',
      [
        'script/chromium-rebase-l10n.py',
        '--source_string_path',
        sourceStringPath,
      ],
      cmdOptions,
    )
  })
  l10nUtil.logRemovedGRDParts(removed)
  copyBraveStringsToOrigin()
}

module.exports = chromiumRebaseL10n
