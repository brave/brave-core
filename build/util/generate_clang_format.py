#!/usr/bin/env vpython3
# Copyright (c) 2024 The Brave Authors. All rights reserved.
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this file,
# You can obtain one at https://mozilla.org/MPL/2.0/.

import argparse
import brave_chromium_utils
import yaml
import os.path


def main(input_clang_format_path, output_clang_format_path):
    # Load input .clang-format file.
    with open(input_clang_format_path, 'r') as file:
        data = yaml.safe_load(file)

    add_include_categories_rules(data)

    # Prepare the new content
    new_content = ('# This file was generated by '
                   f'{brave_chromium_utils.to_wspath(__file__)}\n\n')
    new_content += yaml.safe_dump(data)

    # Load the existing content
    if os.path.exists(output_clang_format_path):
        with open(output_clang_format_path, 'r') as file:
            existing_content = file.read()
    else:
        existing_content = None

    # Write the changes to output .clang-format file if needed.
    if new_content != existing_content:
        with open(output_clang_format_path, 'w', newline='\n') as file:
            file.write(new_content)


def add_include_categories_rules(data):
    # Find the IncludeCategories list.
    include_categories = data['IncludeCategories']

    # Find the '.*' rule and increment its priority.
    for item in include_categories:
        if item['Regex'] == '.*':
            new_priority = item['Priority'] + 1
            break
    else:
        raise RuntimeError("Couldn't find the '.*' rule in IncludeCategories")

    # Add the new item.
    new_item = {
        'Regex': '^"(src\/|..\/gen).*',
        'Priority': new_priority,
    }

    # Insert the new item before the '.*' rule.
    index = next(i for i, item in enumerate(include_categories)
                 if item['Regex'] == '.*')
    include_categories.insert(index, new_item)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description='Generate .clang-format with Brave customization.')
    parser.add_argument('input_clang_format_path',
                        help='Path to the input .clang-format file')
    parser.add_argument('output_clang_format_path',
                        help='Path to the output .clang-format file')

    args = parser.parse_args()

    main(args.input_clang_format_path, args.output_clang_format_path)
